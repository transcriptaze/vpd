<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <title>VCV Panel Designer</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <meta charset="UTF-8">
    <link rel="icon"       href="/images/favicon.png">
    <link rel="stylesheet" href="/css/vpd.css">
  </head>

  <body>
    <header>
      <img id="logo" src="../images/logo.svg" draggable="false"></a>
    </header>
  
    <main>
      <div id="left">
        <div class="panel">
          <object id="light" data="./images/panel-light.svg" width="193" height="400"></object>
        </div>
      </div>
      <div id="right">
        <div class="panel">
          <img src="./images/panel-dark.svg" draggable="false"></a>
        </div>
        <div id="controls">
          <button onclick="onLoad(event)"><img src="./images/load.svg" /></button>
          <button onclick="onSave(event)"><img src="./images/save.svg" /></button>
          <button onclick="onExport(event)"><img src="./images/download.svg" /></button>
          <button onclick="onCtrl1(event)">Ctrl₁</button>
          <button onclick="onCtrl2(event)">Ctrl₂</button>
          <button onclick="onCtrl3(event)">Ctrl₃</button>
          <a id="save" href="" style="display:none" download></a>
          <input id="picker" type="file" accept="application/json" style="display:none;" />
        </div>
      </div>
      <div id="drop">
        <img src="../images/load.svg" />
        <div class="overlay" 
             ondragenter="onDragEnter(event)"
             ondragleave="onDragLeave(event)" 
             ondragover="onDragOver(event)"
             ondrop="onDrop(event)"></div>
      </div>
    </main>
  
    <footer>
      <input id="command" value='new module "woot" 1U 9H' />
      <vpd-help-text id="help-text"></vpd-help-text>
    </footer>

    <!-- TEMPLATES -->
    <template id="template-help-text">
      <div class="vpd-help-text">
        <textarea readonly></textarea>
      </div>
    </template>

  </body>

  <!-- SCRIPTS -->
  <script type="module">
    import "./javascript/components/components.js"
  </script>

  <script src="./wasm/grammar/tree-sitter.js"></script>

  <script type="module">
    import { default as vpd_init } from './wasm/vpd/vpd.js'
    import * as VPD from "./javascript/VPD.js"
    import * as command from "./javascript/command.js"

    (async () => {
      const Parser = window.TreeSitter

      await vpd_init()
      await Parser.init()
      await command.init(Parser)

      VPD.initialise()
    })()

    window.onLoad = VPD.onLoad
    window.onSave = VPD.onSave
    window.onExport = VPD.onExport

    window.onDragEnter = (e) => {
      const drop = document.getElementById('drop')
      const types = e.dataTransfer.types.map((v) => v.toLowerCase())

      if (types.includes("files")) {
        const files = e.dataTransfer.files
        const items = e.dataTransfer.items

        if (files.length > 0 && files.item(0).type === 'application/json') {
           e.preventDefault()
           drop.classList.add('dropping')
        } else if (items.length > 0 && items[0].type == 'application/json') {
           e.preventDefault()      
           drop.classList.add('dropping')
        }
      }
    }

    window.onDragLeave = (e) => {
      const drop = document.getElementById('drop')

      drop.classList.remove('dropping')
    }

    window.onDragOver = (e) => {
      const drop = document.getElementById('drop')
      const types = e.dataTransfer.types.map((v) => v.toLowerCase())

      if (types.includes("files")) {
        const files = e.dataTransfer.files
        const items = e.dataTransfer.items

        if (files.length > 0 && files.item(0).type === 'application/json') {
           e.preventDefault()
           drop.classList.add('dropping')
        } else if (items.length > 0 && items[0].type == 'application/json') {
           e.preventDefault()      
           drop.classList.add('dropping')
        }
      }
    }

    window.onDrop = (e) => {
      e.preventDefault()
      
      const drop = document.getElementById('drop')
      const types = e.dataTransfer.types.map((v) => v.toLowerCase())

      drop.classList.remove('dropping')

      if (types.includes("files")) {
        const files = e.dataTransfer.files
        const items = e.dataTransfer.items

        if (files.length > 0 && files.item(0).type === 'application/json') {
            VPD.onDrop(files.item(0))
        } else if (items.length > 0 && items[0].type == 'application/json') {
            VPD.onDrop(items[0])
        }
      }
    }

    window.onCtrl1 = (event) => {
        document.getElementById('command').focus()
        document.getElementById('command').value = 'new module "woot" 1U 9H'
    }

    window.onCtrl2 = (event) => {
        document.getElementById('command').focus()
        document.getElementById('command').value = 'new guide v1 vertical +4.5mm'
    }

    window.onCtrl3 = (event) => {
        document.getElementById('command').focus()
        document.getElementById('command').value = 'set origin centre,middle'
    }

    window.onkeypress = (event) => {
      if (event.ctrlKey && event.key === '1') {
        onCtrl1()
      }

      if (event.ctrlKey && event.key === '2') {
        onCtrl2()
      }

      if (event.ctrlKey && event.key === '3') {
        onCtrl3()
      }
    }

  </script>
</html>

